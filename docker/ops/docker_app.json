{
    "variables": {
        "docker_image": "phusion/baseimage:latest",
        "docker_repository": "bensojona/packer_2",
        "docker_login_email": "{{env `DOCKER_LOGIN_EMAIL`}}",
        "docker_username": "{{env `DOCKER_USER_NAME`}}",
        "docker_password": "{{env `DOCKER_PASSWORD`}}",
        "docker_login_server": "{{env `DOCKER_LOGIN_SERVER`}}"
    },
    "builders": [
        {
            "type": "docker",
            "image": "{{user `docker_image`}}",
            "export_path": "app_{{timestamp}}.tar"
        }
    ],
    "push": {
      "name": "jb_hashicorp/docker-app",
      "vcs": false
    },
    "provisioners": [
        {
            "type": "shell",
            "inline": [
                "sudo mkdir /ops",
                "sudo chmod a+w /ops"
            ]
        },
        {
            "type": "file",
            "source": ".",
            "destination": "/ops"
        },
        {
            "type": "shell",
            "script": "scripts/consul_base.sh"
        },
        {
            "type": "shell",
            "script": "scripts/consul_client.sh"
        },
        {
            "type": "shell",
            "script": "scripts/apache.sh"
        },
        {
            "type": "shell",
            "inline": [
                "sudo mkdir /app",
                "sudo chmod a+w /app"
            ]
        },
        {
            "type": "shell",
            "inline": [
                "sudo echo nameserver 8.8.8.8 >> /etc/resolv.conf",
                "sudo rm -f /etc/service/sshd/down",
                "sudo cat /ops/terraform/ssh_keys/docker-key.pub >> /root/.ssh/authorized_keys"
            ]
        }
    ],
    "post-processors": [
        [
            {
                "type": "docker-import",
                "repository": "{{user `docker_repository`}}",
                "tag": "app_{{timestamp}}",
                "keep_input_artifact": true
            },
            {
                "type": "docker-push",
                "login": true,
                "login_email": "{{user `docker_login_email`}}",
                "login_username": "{{user `docker_username`}}",
                "login_password": "{{user `docker_password`}}",
                "login_server" : "{{user `docker_login_server`}}"
            }
        ]
    ]
}
